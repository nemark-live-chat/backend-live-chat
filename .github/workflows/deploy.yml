name: Deploy Backend (Windows VPS)

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    env:
      PM2_HOME: C:\pm2

    steps:
      - name: Deploy Backend (main)
        shell: powershell
        run: |
          $pm2 = "C:\Users\Administrator\AppData\Roaming\npm\pm2.cmd"
          $APP_DIR = "C:\apps\backend-prod"
          $BRANCH  = "main"
          $PM2_APP = "backend-prod"

          if (!(Test-Path "$APP_DIR\.git")) {
            throw "‚ùå $APP_DIR ch∆∞a c√≥ git repo"
          }

          Write-Host "üöÄ Deploy backend main ‚Üí $APP_DIR"

          git -C $APP_DIR fetch origin $BRANCH
          git -C $APP_DIR reset --hard "origin/$BRANCH"
          git -C $APP_DIR clean -fd

          cd $APP_DIR
          npm install
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

          & $pm2 start C:\apps\ecosystem.config.js --only $PM2_APP --update-env
          & $pm2 save

          Write-Host "‚úÖ Backend deployed:" (git -C $APP_DIR rev-parse --short HEAD)
