name: Deploy Backend (Windows VPS)

on:
  push:
    branches: [develop, main]

jobs:
  deploy:
    runs-on: self-hosted
    timeout-minutes: 10
    
    env:
      PM2_HOME: C:\pm2
      PM2_PATH: C:\Users\Administrator\AppData\Roaming\npm\pm2.cmd
      ECOSYSTEM_CONFIG: C:\apps\ecosystem.config.js

    steps:
      - name: ğŸš€ Determine deployment environment
        id: env
        shell: powershell
        run: |
          if ("${{ github.ref_name }}" -eq "develop") {
            echo "APP_DIR=C:\apps\backend-dev" >> $env:GITHUB_OUTPUT
            echo "BRANCH=develop" >> $env:GITHUB_OUTPUT
            echo "PM2_APP=backend-dev" >> $env:GITHUB_OUTPUT
            echo "ENV_NAME=Development" >> $env:GITHUB_OUTPUT
          } else {
            echo "APP_DIR=C:\apps\backend-prod" >> $env:GITHUB_OUTPUT
            echo "BRANCH=main" >> $env:GITHUB_OUTPUT
            echo "PM2_APP=backend-prod" >> $env:GITHUB_OUTPUT
            echo "ENV_NAME=Production" >> $env:GITHUB_OUTPUT
          }

      - name: ğŸ“‹ Validate deployment directory
        shell: powershell
        run: |
          $appDir = "${{ steps.env.outputs.APP_DIR }}"
          
          if (!(Test-Path "$appDir")) {
            throw "âŒ Directory $appDir does not exist!"
          }
          
          if (!(Test-Path "$appDir\.git")) {
            throw "âŒ Directory $appDir is not a git repository. Please clone the repo first."
          }
          
          Write-Host "âœ… Deployment directory validated: $appDir"

      - name: ğŸ”„ Pull latest code
        shell: powershell
        run: |
          $appDir = "${{ steps.env.outputs.APP_DIR }}"
          $branch = "${{ steps.env.outputs.BRANCH }}"
          
          Write-Host "ğŸ“¥ Fetching latest code from branch: $branch"
          
          git -C $appDir fetch origin $branch
          if ($LASTEXITCODE -ne 0) { 
            throw "âŒ Git fetch failed"
          }
          
          git -C $appDir reset --hard "origin/$branch"
          if ($LASTEXITCODE -ne 0) { 
            throw "âŒ Git reset failed"
          }
          
          git -C $appDir clean -fd
          
          $commitHash = git -C $appDir rev-parse --short HEAD
          $commitMsg = git -C $appDir log -1 --pretty=%B
          
          Write-Host "âœ… Code updated to commit: $commitHash"
          Write-Host "ğŸ“ Commit message: $commitMsg"

      - name: ğŸ“¦ Install dependencies
        shell: powershell
        run: |
          $appDir = "${{ steps.env.outputs.APP_DIR }}"
          
          Set-Location $appDir
          
          Write-Host "ğŸ“¦ Installing npm dependencies..."
          
          npm ci --prefer-offline --no-audit
          if ($LASTEXITCODE -ne 0) { 
            Write-Host "âš ï¸ npm ci failed, trying npm install..."
            npm install --no-audit
            if ($LASTEXITCODE -ne 0) { 
              throw "âŒ npm install failed"
            }
          }
          
          Write-Host "âœ… Dependencies installed successfully"

      - name: ğŸ”¨ Build (if needed)
        shell: powershell
        run: |
          $appDir = "${{ steps.env.outputs.APP_DIR }}"
          
          Set-Location $appDir
          
          $packageJson = Get-Content package.json -Raw | ConvertFrom-Json
          
          if ($packageJson.scripts.PSObject.Properties.Name -contains "build") {
            Write-Host "ğŸ”¨ Running build script..."
            npm run build
            if ($LASTEXITCODE -ne 0) { 
              throw "âŒ Build failed"
            }
            Write-Host "âœ… Build completed successfully"
          } else {
            Write-Host "â„¹ï¸ No build script found, skipping build step"
          }

      - name: ğŸ”„ Restart PM2 application
        shell: powershell
        run: |
          $pm2 = "${{ env.PM2_PATH }}"
          $ecosystem = "${{ env.ECOSYSTEM_CONFIG }}"
          $pm2App = "${{ steps.env.outputs.PM2_APP }}"
          
          if (!(Test-Path $pm2)) {
            throw "âŒ PM2 not found at: $pm2"
          }
          
          if (!(Test-Path $ecosystem)) {
            throw "âŒ Ecosystem config not found at: $ecosystem"
          }
          
          Write-Host "ğŸ”„ Restarting PM2 app: $pm2App"
          
          # Try to restart first, if it doesn't exist, start it
          & $pm2 restart $pm2App --update-env
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "âš ï¸ App not running, starting fresh..."
            & $pm2 start $ecosystem --only $pm2App --update-env
            if ($LASTEXITCODE -ne 0) { 
              throw "âŒ PM2 start failed"
            }
          }
          
          Write-Host "âœ… PM2 app restarted successfully"

      - name: ğŸ’¾ Save PM2 configuration
        shell: powershell
        run: |
          $pm2 = "${{ env.PM2_PATH }}"
          
          & $pm2 save --force
          if ($LASTEXITCODE -ne 0) { 
            Write-Host "âš ï¸ PM2 save failed (non-critical)"
          } else {
            Write-Host "âœ… PM2 configuration saved"
          }

      - name: ğŸ“Š Deployment summary
        shell: powershell
        run: |
          $appDir = "${{ steps.env.outputs.APP_DIR }}"
          $pm2 = "${{ env.PM2_PATH }}"
          $pm2App = "${{ steps.env.outputs.PM2_APP }}"
          $envName = "${{ steps.env.outputs.ENV_NAME }}"
          
          $commitHash = git -C $appDir rev-parse --short HEAD
          $commitMsg = git -C $appDir log -1 --pretty=%B
          
          Write-Host ""
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          Write-Host "â•‘          ğŸ‰ DEPLOYMENT SUCCESSFUL ğŸ‰                  â•‘"
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          Write-Host ""
          Write-Host "ğŸŒ Environment:   $envName"
          Write-Host "ğŸ“ Directory:     $appDir"
          Write-Host "ğŸ”– Branch:        ${{ steps.env.outputs.BRANCH }}"
          Write-Host "ğŸ“Œ Commit:        $commitHash"
          Write-Host "ğŸ“ Message:       $commitMsg"
          Write-Host "ğŸš€ PM2 App:       $pm2App"
          Write-Host ""
          Write-Host "ğŸ“Š PM2 Status:"
          & $pm2 list
          Write-Host ""
